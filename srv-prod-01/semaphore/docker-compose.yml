services:
  semaphore-db:
    image: docker.io/library/mysql:8.4
    container_name: semaphore-db
    hostname: semaphore-db
    volumes:
      - ${APPS_DB}/semaphore_db/data:/var/lib/mysql
    environment:
      - MYSQL_RANDOM_ROOT_PASSWORD=yes
      - MYSQL_DATABASE=semaphore
      - MYSQL_USER=semaphore
      # - MYSQL_PASSWORD=${MYSQL_PASSWORD}
    restart: unless-stopped
    networks:
      - semaphorenet

  semaphore:
    container_name: semaphore
    image: docker.io/semaphoreui/semaphore:latest
    restart: unless-stopped
    # user: "${PUID}:${PGID}"
    # ports:
    #   - 3071:3000
    env_file:
      - secrets.env
    environment:
      - SEMAPHORE_DB_USER=semaphore
      # - SEMAPHORE_DB_PASS=${MYSQL_PASSWORD} 
      - SEMAPHORE_DB_HOST=semaphore-db
      - SEMAPHORE_DB_PORT=3306
      - SEMAPHORE_DB_DIALECT=mysql
      - SEMAPHORE_DB=semaphore
      - SEMAPHORE_PLAYBOOK_PATH=/tmp/semaphore/
      # - SEMAPHORE_ACCESS_KEY_ENCRYPTION=${SEMAPHORE_ACCESS_KEY_ENCRYPTION}  # add to your access key encryption !
      - ANSIBLE_HOST_KEY_CHECKING=false  # (optional) change to true if you want to enable host key checking
      - TZ=${TZ}
    volumes:
      - ${DOCKER_DIR}/semaphore/inventory/:/inventory:ro
      - ${DOCKER_DIR}/semaphore/playbook/:/playbook:ro
      - ${DOCKER_DIR}/semaphore/authorized-keys/:/authorized-keys:ro
      - ${DOCKER_DIR}/semaphore/config/:/etc/semaphore:rw
    depends_on:
      - semaphore-db
    networks:
      - semaphorenet
      - proxy
    labels:
    #TRAEFIK
      - "traefik.enable=true"
      - "traefik.http.routers.semaphore.entrypoints=http"
      - "traefik.http.routers.semaphore.rule=Host(`semaphore.${DOMAIN}`)" 
      - "traefik.http.middlewares.semaphore-https-redirect.redirectscheme.scheme=https"
      - "traefik.http.routers.semaphore.middlewares=semaphore-https-redirect"
      - "traefik.http.routers.semaphore-secure.entrypoints=https"
      - "traefik.http.routers.semaphore-secure.rule=Host(`semaphore.${DOMAIN}`)" 
      - "traefik.http.routers.semaphore-secure.tls=true"
      - "traefik.http.routers.semaphore-secure.service=semaphore"
      - "traefik.http.services.semaphore.loadbalancer.server.port=3000"
      - "traefik.docker.network=proxy"
    #HOMEPAGE
      - homepage.group=${HOMEPAGE_GROUP}
      - homepage.name=semaphore
      - homepage.icon=semaphore.png
      - homepage.href=https://semaphore.${DOMAIN}
    security_opt:
      - no-new-privileges:true

networks:
  semaphorenet:
    name: semaphorenet
    driver: bridge
  proxy:
    external: true
